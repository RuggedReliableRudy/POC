AWSTemplateFormatVersion: 2010-09-09
Description: Project admin role with S3 and Secrets Manager access

Resources:
  rPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Glue Job access to S3 and RDS Secrets
      Path: /project/
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: S3Access
            Effect: Allow
            Action:
              - s3:ListBucket
              - s3:GetObject
              - s3:PutObject
              - s3:DeleteObject
            Resource: 
              - !Sub arn:${AWS::Partition}:s3:::sourcebucket
              - !Sub arn:${AWS::Partition}:s3:::sourcebucket/*
              - !Sub arn:${AWS::Partition}:s3:::destbucket
              - !Sub arn:${AWS::Partition}:s3:::destbucket/*

          - Sid: GetRDSSecret
            Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
              - secretsmanager:DescribeSecret
            # Restrict this to your specific secret for better security
            Resource: !Sub arn:${AWS::Partition}:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:project-*

rRole:
    Type: AWS::IAM::Role
    Properties:
      Path: /project/
      PermissionsBoundary: !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:policy/vaec/project-admin
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
        - Effect: Allow
          Principal:
            Service: !Sub glue.${AWS::URLSuffix}
          Action:
          - sts:AssumeRole
      ManagedPolicyArns:
        - !Ref rPolicy
        - !Sub arn:${AWS::Partition}:iam::aws:policy/service-role/AWSGlueServiceRole
      # This replaces your glue-inline-policy.json
      Policies:
        - PolicyName: glue-inline-policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action: "iam:PassRole"
                # Scoped to roles within your project path for better security
                Resource: !Sub "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/project/*"
